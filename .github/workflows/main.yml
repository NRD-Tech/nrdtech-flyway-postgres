name: Deploy Database

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy-database-staging:
    runs-on: ubuntu-latest
    if: |
      !failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get GitHub Runner IP
        id: runner-ip
        run: |
          # Get the public IP of the GitHub runner
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $RUNNER_IP"
          echo "ip=$RUNNER_IP" >> $GITHUB_OUTPUT

      - name: Load configuration
        id: config
        run: |
          source config.global
          source config.staging
          echo "aws-role-arn=$AWS_ROLE_ARN" >> $GITHUB_OUTPUT
          echo "aws-region=$AWS_DEFAULT_REGION" >> $GITHUB_OUTPUT
          echo "app-ident=$APP_IDENT" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.config.outputs.aws-role-arn }}
          aws-region: ${{ steps.config.outputs.aws-region }}

      - name: Add GitHub Runner IP to Security Group
        id: add-ip
        run: |
          source config.global
          source config.staging
          SG_NAME="${SECURITY_GROUP}"
          RUNNER_IP="${{ steps.runner-ip.outputs.ip }}"
          
          # Find security group by name
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=${SG_NAME}" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          
          if [ "$SG_ID" == "None" ] || [ -z "$SG_ID" ]; then
            echo "Error: Security group ${SG_NAME} not found"
            exit 1
          fi
          
          echo "Security Group ID: $SG_ID"
          echo "sg-id=$SG_ID" >> $GITHUB_OUTPUT
          
          # Add ingress rule for GitHub runner IP
          aws ec2 authorize-security-group-ingress \
            --group-id "$SG_ID" \
            --ip-permissions "[{\"IpProtocol\":\"tcp\",\"FromPort\":5432,\"ToPort\":5432,\"IpRanges\":[{\"CidrIp\":\"${RUNNER_IP}/32\",\"Description\":\"GitHub Actions runner IP\"}]}]" || true

      - name: Deploy Database to Staging
        env:
          DATABASE_MASTER_PASSWORD: ${{ secrets.DATABASE_MASTER_PASSWORD_STAGING }}
        run: |
          chmod +x ./*.sh
          ENVIRONMENT=staging ./migrate.sh

      - name: Remove GitHub Runner IP from Security Group
        if: always()
        run: |
          source config.global
          source config.staging
          SG_ID="${{ steps.add-ip.outputs.sg-id }}"
          RUNNER_IP="${{ steps.runner-ip.outputs.ip }}"
          
          if [ -n "$SG_ID" ] && [ "$SG_ID" != "None" ]; then
            # Remove ingress rule for GitHub runner IP
            aws ec2 revoke-security-group-ingress \
              --group-id "$SG_ID" \
              --ip-permissions "[{\"IpProtocol\":\"tcp\",\"FromPort\":5432,\"ToPort\":5432,\"IpRanges\":[{\"CidrIp\":\"${RUNNER_IP}/32\"}]}]" || true
          fi

  deploy-database-production:
    runs-on: ubuntu-latest
    if: |
      !failure() && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get GitHub Runner IP
        id: runner-ip
        run: |
          # Get the public IP of the GitHub runner
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $RUNNER_IP"
          echo "ip=$RUNNER_IP" >> $GITHUB_OUTPUT

      - name: Load configuration
        id: config
        run: |
          source config.global
          source config.prod
          echo "aws-role-arn=$AWS_ROLE_ARN" >> $GITHUB_OUTPUT
          echo "aws-region=$AWS_DEFAULT_REGION" >> $GITHUB_OUTPUT
          echo "app-ident=$APP_IDENT" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.config.outputs.aws-role-arn }}
          aws-region: ${{ steps.config.outputs.aws-region }}

      - name: Add GitHub Runner IP to Security Group
        id: add-ip
        run: |
          source config.global
          source config.prod
          SG_NAME="${SECURITY_GROUP}"
          RUNNER_IP="${{ steps.runner-ip.outputs.ip }}"
          
          # Find security group by name
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=${SG_NAME}" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          
          if [ "$SG_ID" == "None" ] || [ -z "$SG_ID" ]; then
            echo "Error: Security group ${SG_NAME} not found"
            exit 1
          fi
          
          echo "Security Group ID: $SG_ID"
          echo "sg-id=$SG_ID" >> $GITHUB_OUTPUT
          
          # Add ingress rule for GitHub runner IP
          aws ec2 authorize-security-group-ingress \
            --group-id "$SG_ID" \
            --ip-permissions "[{\"IpProtocol\":\"tcp\",\"FromPort\":5432,\"ToPort\":5432,\"IpRanges\":[{\"CidrIp\":\"${RUNNER_IP}/32\",\"Description\":\"GitHub Actions runner IP\"}]}]" || true

      - name: Deploy Database to Production
        env:
          DATABASE_MASTER_PASSWORD: ${{ secrets.DATABASE_MASTER_PASSWORD_PROD }}
        run: |
          chmod +x ./*.sh
          ENVIRONMENT=prod ./migrate.sh

      - name: Remove GitHub Runner IP from Security Group
        if: always()
        run: |
          source config.global
          source config.prod
          SG_ID="${{ steps.add-ip.outputs.sg-id }}"
          RUNNER_IP="${{ steps.runner-ip.outputs.ip }}"
          
          if [ -n "$SG_ID" ] && [ "$SG_ID" != "None" ]; then
            # Remove ingress rule for GitHub runner IP
            aws ec2 revoke-security-group-ingress \
              --group-id "$SG_ID" \
              --ip-permissions "[{\"IpProtocol\":\"tcp\",\"FromPort\":5432,\"ToPort\":5432,\"IpRanges\":[{\"CidrIp\":\"${RUNNER_IP}/32\"}]}]" || true
          fi
